# Gatekeeper Worker

## Назначение

Gatekeeper Worker отвечает за **контроль доступа** пользователей к чату. Основная функция - проверка и установка таймзоны пользователя.

## Логика работы

### 1. Проверка доступа
- Все входящие webhook сообщения от Telegram поступают в Gatekeeper
- Gatekeeper проверяет, установлена ли у пользователя таймзона
- Если таймзона есть → пересылает сообщение в Chat Worker
- Если таймзоны нет → переходит к процессу установки

### 2. Установка таймзоны
- При первом контакте или отсутствии таймзоны просит пользователя указать город или время
- Использует AI (OpenAI) для определения таймзоны из текста сообщения
- После успешной установки разрешает доступ к полноценному чату

### 3. Маршрутизация
```
Webhook → Gatekeeper → Проверка таймзоны
                   ├── Есть таймзона → Chat Worker (полный функционал)
                   └── Нет таймзоны → Установка таймзоны → Chat Worker
```

## Файловая структура

```
gatekeeper/
├── tasks.py              # Основная логика воркера
├── models.py             # Pydantic модели
├── README.md            # Этот файл
└── prompts/
    └── timezone_parse.md # AI промпт для определения таймзоны
```

## Функции

### `process_webhook_message()`
- Главная точка входа для всех сообщений
- Dramatiq actor с retry политикой
- Инициализирует DB подключения

### `process_timezone_message()`
- Использует AI для определения таймзоны из текста
- Обновляет пользователя в базе данных
- Возвращает результат установки

## AI Integration

Использует OpenAI GPT для:
- Распознавания города из естественного языка
- Определения таймзоны по названию города
- Вычисления таймзоны по указанному времени

## Redis Flags

- `timezone_setup_flag:{user_id}` - флаг режима установки таймзоны
- Устанавливается при первом контакте
- Очищается после успешной установки

## Ограничения

Gatekeeper НЕ занимается:
- Созданием задач (это делает Chat Worker)
- Обработкой команд управления задачами
- AI-диалогами на свободные темы
- Напоминаниями и уведомлениями

Его единственная задача - **проверить таймзону и пропустить в чат**.