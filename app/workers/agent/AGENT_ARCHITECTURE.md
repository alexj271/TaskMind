# Agent Architecture - –î–≤—É—Ö–∞–≥–µ–Ω—Ç–Ω–∞—è –°—Ö–µ–º–∞ —Å StateManager

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
User
 ‚îÇ
 ‚îÇ 1. –°–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —è–∑—ã–∫)
 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dialog Agent (gpt-4.1-mini)      ‚îÇ
‚îÇ _dialog_agent_understand_intent  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 ‚îÇ
 ‚îÇ 2. –ü–æ–Ω–∏–º–∞–Ω–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è
 ‚îÇ    ‚Ä¢ intent (create_task, list_tasks, ...)
 ‚îÇ    ‚Ä¢ entities (–Ω–∞–∑–≤–∞–Ω–∏—è, –¥–∞—Ç—ã, ID)
 ‚îÇ    ‚Ä¢ needs_clarification?
 ‚îÇ
 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
 ‚îÇ clarification?‚îÇ YES
 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 ‚îÇ        ‚îÇ
 ‚îÇ        ‚ñº
 ‚îÇ   –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 ‚îÇ   (—É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å)
 ‚îÇ
 ‚îÇ NO
 ‚ñº
Intent Payload (JSON)
 ‚îÇ
 ‚îÇ 3. get_relevant_context()
 ‚îÇ    (relevance pruning)
 ‚îÇ
 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Decision Engine (gpt-4.1-nano)   ‚îÇ
‚îÇ _decision_engine_choose_action   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 ‚îÇ
 ‚îÇ 4. –ê–Ω–∞–ª–∏–∑:
 ‚îÇ    ‚Ä¢ intent + entities
 ‚îÇ    ‚Ä¢ current_state
 ‚îÇ    ‚Ä¢ available_tools
 ‚îÇ
 ‚îÇ 5. –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
 ‚îÇ    ‚Üí tool_call | noop
 ‚îÇ
 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Tool Executor                    ‚îÇ
‚îÇ _execute_tool                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 ‚îÇ
 ‚îÇ 6. –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ MCP —Ñ—É–Ω–∫—Ü–∏–∏
 ‚ñº
Tool Result
 ‚îÇ
 ‚îÇ 7. State Update
 ‚îÇ    ‚Ä¢ _update_state_from_tool_result
 ‚îÇ    ‚Ä¢ StateManager.add_action()
 ‚îÇ    ‚Ä¢ StateManager.add_task() / update_task_status()
 ‚îÇ
 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ StateManager                     ‚îÇ
‚îÇ optimize_state()                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 ‚îÇ
 ‚îÇ 7.1. State Optimization ‚Üê –ó–î–ï–°–¨!
 ‚îÇ      ‚Ä¢ Structural (prune closed tasks, trim actions)
 ‚îÇ      ‚Ä¢ Semantic (summarize dialog if needed)
 ‚îÇ      ‚Ä¢ Normalize timestamps
 ‚îÇ
 ‚îÇ 8. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis
 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dialog Agent (gpt-4.1-mini)      ‚îÇ
‚îÇ _dialog_agent_format_response    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
 ‚îÇ
 ‚îÇ 9. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
 ‚ñº
User
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Dialog Agent (gpt-4.1-mini)

**–ö–ª–∞—Å—Å:** `DialogAgent` (–≤ `dialog_agent.py`)

**–†–æ–ª—å:** –ü–æ–Ω–∏–º–∞–Ω–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤

**–ú–µ—Ç–æ–¥—ã:**
- `understand_intent(message_text)` ‚Äî –∞–Ω–∞–ª–∏–∑ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `format_response(intent, tool_name, tool_result)` ‚Äî —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- `format_simple_response(message)` ‚Äî –ø—Ä–æ—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è noop

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ intent –∏ entities
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
- Fallback –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–ü—Ä–æ–º–ø—Ç—ã:**
- `dialog_agent_intent.md` ‚Äî –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è
- `dialog_agent_response.md` ‚Äî –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
dialog_agent = DialogAgent(user_id=123)
```

### 2. Decision Engine (gpt-4.1-nano)

**–ö–ª–∞—Å—Å:** `DecisionEngine` (–≤ `decision_engine.py`)

**–†–æ–ª—å:** –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π –æ –≤—ã–±–æ—Ä–µ –¥–µ–π—Å—Ç–≤–∏—è

**–ú–µ—Ç–æ–¥—ã:**
- `choose_action(intent_payload, state_context, available_tools)` ‚Äî –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
- `choose_action_with_validation(...)` ‚Äî –≤—ã–±–æ—Ä —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- `_validate_decision(decision, available_tools)` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è

**–í—Ö–æ–¥:**
- Intent payload (intent, entities)
- State context (relevant_tasks, recent_actions, dialog_summary)
- Available tools

**–í—ã—Ö–æ–¥:**
- `action_type`: "tool_call" | "noop"
- `tool_name`: –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (–µ—Å–ª–∏ tool_call)
- `tool_arguments`: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤—ã–∑–æ–≤–∞

**–í–∞–ª–∏–¥–∞—Ü–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è tool –≤ available_tools
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
- Fallback –Ω–∞ noop –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ä–µ—à–µ–Ω–∏–∏

**–ü—Ä–æ–º–ø—Ç:** `decision_engine.md`

**–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:**
```python
decision_engine = DecisionEngine(user_id=123)
```

### 3. StateManager

**–†–æ–ª—å:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å Redis —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ state:**
```python
{
  "user_id": int,
  "current_context": {
    "active_intent": str,
    "mentioned_entities": List[str],
    "last_interaction": str
  },
  "current_tasks": List[Task],
  "recent_actions": List[Action],
  "dialog_history": List[Message],
  "dialog_summary": str,
  "archived_topics": List[Topic],
  "long_term_context": Dict,
  "metadata": {
    "total_interactions": int,
    "optimization_count": int,
    "last_optimization": str
  }
}
```

**–ú–µ—Ç–æ–¥—ã:**

**–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:**
- `load_from_redis()` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∞–≥–µ–Ω—Ç–∞
- `sync_to_redis(ttl=86400)` ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**
- `update_current_context()`
- `add_task()`, `update_task_status()`, `remove_task()`
- `add_action()`
- `add_dialog_message()`

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- `optimize_state()` ‚Äî —Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- `get_relevant_context()` ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è nano API

**–£—Ä–æ–≤–Ω–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

1. **Structural** (–≤—Å–µ–≥–¥–∞):
   - –£–¥–∞–ª–µ–Ω–∏–µ completed/cancelled –∑–∞–¥–∞—á
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ recent_actions –¥–æ 10
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ current_tasks –¥–æ 20

2. **Semantic** (–ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):
   - –¢—Ä–∏–≥–≥–µ—Ä: >30 messages –∏–ª–∏ >2000 tokens
   - GPT-4.1-mini —Å–æ–∑–¥–∞—ë—Ç summary
   - –°–∂–∞—Ç–∏–µ dialog_history –¥–æ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö

3. **Relevance Pruning** (–ø–æ –∑–∞–ø—Ä–æ—Å—É):
   - Scoring: mention +3, recent +2, intent match +1
   - –í–æ–∑–≤—Ä–∞—Ç top-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∑–∞–¥–∞—á

### 4. Tool Executor

**–†–æ–ª—å:** –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ MCP —Ñ—É–Ω–∫—Ü–∏–π

**–§—É–Ω–∫—Ü–∏—è:** `_execute_tool()`

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:**
- `create_task` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
- `get_user_tasks` ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
- `update_task_status` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
- `search_tasks` ‚Äî –ø–æ–∏—Å–∫ –∑–∞–¥–∞—á

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `user_id` –≤ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
- –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ inline keyboard
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å pending —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

## –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏)

```
1. User: "–°–æ–∑–¥–∞–π –∑–∞–¥–∞—á—É –∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"

2. Dialog Agent:
   {
     "intent": "create_task",
     "entities": ["–∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"],
     "needs_clarification": false
   }

3. StateManager.get_relevant_context()
   (relevance pruning –¥–ª—è Decision Engine)

4. Decision Engine:
   {
     "action_type": "tool_call",
     "tool_name": "create_task",
     "tool_arguments": {"title": "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"}
   }

5. Tool Executor ‚Üí MCP create_task
   Result: {"success": true, "task_id": "123"}

6. StateManager.add_task("123", "active", "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ")
   StateManager.add_action("tool_call_success", ...)

7. StateManager.optimize_state() ‚Üê –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ó–î–ï–°–¨!
   {
     "tasks_removed": 2,
     "actions_trimmed": 5,
     "dialog_compressed": 0
   }

8. StateManager.sync_to_redis()

9. Dialog Agent Format:
   "‚úÖ –ì–æ—Ç–æ–≤–æ! –ó–∞–¥–∞—á–∞ '–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ' —Å–æ–∑–¥–∞–Ω–∞."

10. User –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç
```

### –°—Ü–µ–Ω–∞—Ä–∏–π —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º

```
1. User: "–ó–∞–¥–∞—á–∞"

2. Dialog Agent:
   {
     "intent": "create_task",
     "entities": [],
     "needs_clarification": true,
     "clarification_question": "–ö–∞–∫—É—é –∑–∞–¥–∞—á—É —Å–æ–∑–¥–∞—Ç—å?"
   }

3. StateManager.update_current_context(intent="clarification_needed")
   StateManager.sync_to_redis()

4. Return "–ö–∞–∫—É—é –∑–∞–¥–∞—á—É —Å–æ–∑–¥–∞—Ç—å?"

5. User: "–ö—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ"
   ‚Üí (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Ü–∏–∫–ª —Å —à–∞–≥–∞ 1)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π noop

```
1. User: "–ü—Ä–∏–≤–µ—Ç"

2. Dialog Agent:
   {
     "intent": "greeting",
     "entities": [],
     "needs_clarification": false
   }

3. Decision Engine:
   {
     "action_type": "noop",
     "message": "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π"
   }

4. Return "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

‚úÖ **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
- `DialogAgent` ‚Äî –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∏ –æ–±—â–µ–Ω–∏–µ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å)
- `DecisionEngine` ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å)
- `AgentSession` ‚Äî –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è
- `StateManager` ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (–æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å)
- Tool Executor ‚Äî –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (–º–µ—Ç–æ–¥ –≤ AgentSession)

‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –õ–µ–≥–∫–æ –º–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- –ü—Ä–æ—Å—Ç–∞—è –∏–∑–æ–ª—è—Ü–∏—è –ª–æ–≥–∏–∫–∏

‚úÖ **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ—Å—Ç—å:**
- DialogAgent, DecisionEngine, StateManager –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö
- –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç:**
- gpt-4.1-mini –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á (DialogAgent)
- gpt-4.1-nano –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π (DecisionEngine)

‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- State –≤ Redis (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å, –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ)
- –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å/—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å)

‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å:**
- Relevance pruning ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- Semantic compression ‚Äî —Å–∂–∞—Ç–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
- Structural optimization ‚Äî —á–∏—Å—Ç–æ—Ç–∞ state

‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å:**
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ intent'—ã
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ tools
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø—Ä–æ–º–ø—Ç—ã
- –ó–∞–º–µ–Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–ú–æ–¥–µ–ª–∏:**
- Dialog Agent: `gpt-4.1-mini` (–ø–æ–Ω–∏–º–∞–Ω–∏–µ, –æ—Ç–≤–µ—Ç—ã)
- Decision Engine: `gpt-4.1-nano` (–≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è)
- Semantic Compression: `gpt-4.1-mini` (—Å–∂–∞—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞)

**State Limits:**
- MAX_RECENT_ACTIONS = 10
- MAX_DIALOG_HISTORY = 50
- MAX_DIALOG_TOKENS = 2000
- MAX_CURRENT_TASKS = 20
- MAX_CONTEXT_TASKS = 5 (–¥–ª—è relevance pruning)

**Redis:**
- Key: `agent:state:{user_id}`
- TTL: 86400 —Å–µ–∫—É–Ω–¥ (24 —á–∞—Å–∞)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç—ã StateManager
pytest app/workers/agent/tests/test_state_manager.py -v

# –¢–µ—Å—Ç—ã MessageBuilder
pytest app/workers/agent/tests/test_messages.py -v
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–õ–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç:
- `[AGENT {user_id}:{agent_id}]` ‚Äî –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞
- Intent detection results
- Decision Engine choices
- Tool execution results
- State optimization stats
- Error traces

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
```
User: "–°–æ–∑–¥–∞–π –∑–∞–¥–∞—á—É –∫—É–ø–∏—Ç—å –º–æ–ª–æ–∫–æ –∑–∞–≤—Ç—Ä–∞"
‚Üí Intent: create_task
‚Üí Decision: tool_call create_task
‚Üí Result: "‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞"
```

### –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
```
User: "–ü–æ–∫–∞–∂–∏ –º–æ–∏ –∑–∞–¥–∞—á–∏"
‚Üí Intent: list_tasks
‚Üí Decision: tool_call get_user_tasks
‚Üí Result: "üìã –í–∞—à–∏ –∑–∞–¥–∞—á–∏: ..."
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
```
User: "–û—Ç–º–µ—Ç—å –∑–∞–¥–∞—á—É 123 –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é"
‚Üí Intent: update_task
‚Üí Decision: tool_call update_task_status
‚Üí Result: "‚úÖ –ó–∞–¥–∞—á–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π"
```

### –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
```
User: "–ü—Ä–∏–≤–µ—Ç"
‚Üí Intent: greeting
‚Üí Decision: noop
‚Üí Result: "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
```
